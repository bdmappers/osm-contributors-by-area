$(function(){function a(a){var b="";return i.addClass("loading"),$.ajax({async:!1,url:"http://api.openstreetmap.org/api/0.6/user/"+a,dataType:"xml",success:function(a){b=$(a).find("img").attr("href"),i.removeClass("loading")}}),b}function b(a){var b,c,d=[];if(a instanceof L.Polygon||a instanceof L.Polyline){for(var e=a.getLatLngs(),f=0;f<e.length;f++)d.push(e[f].lng+" "+e[f].lat),0===f&&(b=e[f].lng,c=e[f].lat);if(a instanceof L.Polygon)return"POLYGON(("+d.join(",")+","+b+" "+c+"))";if(a instanceof L.Polyline)return"LINESTRING("+d.join(",")+")"}else if(a instanceof L.Marker)return"POINT("+a.getLatLng().lng+" "+a.getLatLng().lat+")"}function c(a,c,d){var e=new jsts.io.WKTReader,f=new jsts.io.GeoJSONWriter,g=b(a),h=b(c),i=e.read(g).intersection(e.read(h));return i=f.write(i),i=L.GeoJSON.geometryToLayer(i),i.setStyle({color:d,opacity:1,fill:!1,fillOpacity:.2}),i}var d=14,e=new L.Map("map",{attribution:'<a href="http://leafletjs.com/">Leaflet</a> &bull; <a href="http://osm.org/" target="_blank">OpenStreetMap contributors</a>',layers:L.tileLayer("http://a.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png"),minZoom:d}),f="http://overpass-api.de/api/interpreter?";e.setView(L.latLng(42.4461,12.4937),d);var g=L.layerGroup([]).addTo(e),h={},i=$("#sidebar"),j=$("#userlist");window.map=e,window.users=h,window.geoLayer=g,L.layerJSON({caching:!1,url:f+"data=[out:json];node({lat1},{lon1},{lat2},{lon2});out meta;",propertyItems:"elements",propertyTitle:"tags.name",propertyLoc:["lat","lon"],dataToMarker:function(b,c){return h[b.uid]?h[b.uid].locs.push(c):h[b.uid]={username:b.user,avatar:a(b.uid),color:rgb2hex(randcolor()),locs:[c]},!1}}).on("dataloading",function(){console.log("dataloading"),j.empty()}).on("dataloaded",function(){g.clearLayers();var a=L.rectangle(e.getBounds().pad(-.98));for(var b in h){var d=L.rectangle(L.latLngBounds(h[b].locs));window.inter=c(a,d,h[b].color),g.addLayer(window.inter),j.append('<div class="useritem" style="background:'+h[b].color+'"><img height="24" width="25" src="'+h[b].avatar+'" /> <a target="_blank" href="http://osm.org/user/'+h[b].username+'">'+h[b].username+"</a></div>")}}).addTo(e),L.control.sidebar("sidebar",{position:"right"}).addTo(e).show()});